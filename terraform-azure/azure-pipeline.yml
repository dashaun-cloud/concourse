resource_types:

  - name: terraform
    type: docker-image
    source:
      repository: ljfranklin/terraform-resource
      tag: 0.11.14

resources:

  - name: terraforming-azure-repository
    type: git
    source:
      branch: ((git_branch))
      uri: ((git_uri))
      private_key: ((git_ssh_key))

  - name: terraform
    type: terraform
    source:
      env_name: ((env_name))
      backend_type: azurerm
      backend_config:
        container_name: ((container_name))
        key: ((key))
        storage_account_name: ((storage_account_name))
        resource_group_name: ((resource_group_name))
        access_key: ((access_key))
      delete_on_failure: false
      vars:
        env_name: ((env_name))
        location: ((location))
        subscription_id: ((subscription_id))
        tenant_id: ((tenant_id))
        client_id: ((client_id))
        client_secret: ((client_secret))
        dns_subdomain: ((dns_subdomain))
        dns_suffix: ((dns_suffix))
        ops_manager_image_uri: ((ops_manager_image_uri))
        repository_directory: ((repository_directory))

jobs:
  - name: terraform-apply
    plan:
    - get: terraforming-azure-repository
      trigger: false
    - put: terraform
      params:
        env_name: ((env_name))
        terraform_source: terraforming-azure-repository/((repository_directory))

  - name: terraform-destroy
    plan:
    - get: terraforming-azure-repository
      trigger: false
    - put: terraform
      get_params:
        action: destroy
      params:
        action: destroy
        env_name: ((env_name))
        terraform_source: terraforming-azure-repository/((repository_directory))
